@page "/upload"
@using DocumentProcessor.Web.Models
@using DocumentProcessor.Web.Data
@using DocumentProcessor.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@inject FileStorageService DocumentSource
@inject IServiceScopeFactory ServiceScopeFactory
@inject DocumentProcessingService DocumentProcessingService
@inject ILogger<DocumentUpload> Logger
@rendermode InteractiveServer

<PageTitle>Upload Documents</PageTitle>

<div class="container mt-4">
    <h1>Document Upload</h1>
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Upload Documents</h5>
                    <div class="upload-area @(_isDragOver ? "drag-over" : "")" @ondragenter="() => _isDragOver = true" @ondragleave="() => _isDragOver = false">
                        <div class="text-center p-5">
                            <i class="bi bi-cloud-upload" style="font-size: 3rem;"></i>
                            <p class="mt-3">Drag and drop files here or click to browse</p>
                            <p class="small text-muted mb-3">
                                <i class="bi bi-info-circle me-1"></i>
                                Suggested location: <code>C:\MAM319\DPS\docs</code>
                            </p>
                            <label for="fileUploadInput" class="btn btn-primary mt-2" style="cursor: pointer;">
                                <i class="bi bi-folder-open me-2"></i>Choose Files
                                <InputFile id="fileUploadInput" OnChange="@LoadFiles" multiple accept=".pdf,.doc,.docx,.txt,.xlsx,.xls,.csv" style="display: none;" />
                            </label>
                        </div>
                    </div>

                    @if (_selectedFiles.Any())
                    {
                        <div class="mt-4">
                            <h6>Selected Files:</h6>
                            <ul class="list-group">
                                @foreach (var file in _selectedFiles)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div><i class="bi bi-file-earmark me-2"></i>@file.Name <small class="text-muted ms-2">(@GetFileSize(file.Size))</small></div>
                                        <button class="btn btn-sm btn-danger" @onclick="() => _selectedFiles.Remove(file)"><i class="bi bi-x"></i></button>
                                    </li>
                                }
                            </ul>
                            <div class="mt-3">
                                <button class="btn btn-primary" @onclick="UploadFiles" disabled="@_isUploading">
                                    @if (_isUploading) { <span class="spinner-border spinner-border-sm me-2"></span> <span>Uploading...</span> }
                                    else { <i class="bi bi-upload me-2"></i> <span>Upload Files</span> }
                                </button>
                                <button class="btn btn-secondary ms-2" @onclick="() => { _selectedFiles.Clear(); _uploadProgress.Clear(); }" disabled="@_isUploading">Clear All</button>
                            </div>
                        </div>
                    }

                    @if (_uploadProgress.Any())
                    {
                        <div class="mt-4">
                            <h6>Upload Progress:</h6>
                            @foreach (var p in _uploadProgress)
                            {
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between"><small>@p.FileName</small><small>@p.Progress%</small></div>
                                    <div class="progress"><div class="progress-bar @(p.IsComplete ? "bg-success" : "")" style="width: @p.Progress%"></div></div>
                                    @if (!string.IsNullOrEmpty(p.Error)) { <small class="text-danger">@p.Error</small> }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            @if (_messages.Any())
            {
                <div class="mt-3">
                    @foreach (var m in _messages)
                    {
                        <div class="alert alert-@m.Type alert-dismissible fade show">@m.Text<button type="button" class="btn-close" @onclick="() => _messages.Remove(m)"></button></div>
                    }
                </div>
            }
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Recent Uploads</h5>
                    @if (_recentDocuments.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var doc in _recentDocuments)
                            {
                                <div class="list-group-item px-0">
                                    <div class="d-flex w-100 justify-content-between"><h6 class="mb-1">@doc.FileName</h6><small>@doc.CreatedAt.ToString("g")</small></div>
                                    <p class="mb-1 small text-muted">@GetFileSize(doc.FileSize)</p>
                                    <small class="text-muted">Status: <span class="badge bg-@GetStatusColor(doc.Status)">@doc.Status</span></small>
                                </div>
                            }
                        </div>
                    }
                    else { <p class="text-muted">No recent uploads</p> }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .upload-area { border: 2px dashed #dee2e6; border-radius: 0.375rem; background-color: #f8f9fa; transition: all 0.3s ease; cursor: pointer; }
    .upload-area:hover { border-color: #0d6efd; background-color: #e7f1ff; }
    .upload-area.drag-over { border-color: #0d6efd; background-color: #cfe2ff; border-width: 3px; }
</style>

@code {
    private List<IBrowserFile> _selectedFiles = new();
    private List<UploadProgress> _uploadProgress = new();
    private List<Message> _messages = new();
    private List<Document> _recentDocuments = new();
    private bool _isUploading, _isDragOver;
    private const long MaxFileSize = 50 * 1024 * 1024;

    protected override async Task OnInitializedAsync() => await LoadRecentDocuments();

    private async Task LoadRecentDocuments()
    {
        try
        {
            using var scope = ServiceScopeFactory.CreateScope();
            var repo = scope.ServiceProvider.GetRequiredService<DocumentRepository>();
            _recentDocuments = (await repo.GetAllAsync()).OrderByDescending(d => d.CreatedAt).Take(5).ToList();
        }
        catch (Exception ex) { Logger.LogError(ex, "Error loading recent documents"); }
    }

    private void LoadFiles(InputFileChangeEventArgs e)
    {
        _selectedFiles.Clear();
        _messages.Clear();
        try
        {
            var validExts = new[] { ".pdf", ".doc", ".docx", ".txt", ".xlsx", ".xls", ".csv" };
            foreach (var file in e.GetMultipleFiles(10))
            {
                if (file.Size > MaxFileSize) { AddMessage($"'{file.Name}' exceeds max size", "warning"); continue; }
                if (!validExts.Contains(Path.GetExtension(file.Name).ToLowerInvariant())) { AddMessage($"'{file.Name}' unsupported type", "warning"); continue; }
                _selectedFiles.Add(file);
            }
            if (_selectedFiles.Any()) AddMessage($"Selected {_selectedFiles.Count} file(s)", "info");
        }
        catch { AddMessage("Error loading files", "danger"); }
        StateHasChanged();
    }

    private async Task UploadFiles()
    {
        if (!_selectedFiles.Any()) return;
        _isUploading = true;
        _uploadProgress.Clear();
        _messages.Clear();

        foreach (var file in _selectedFiles)
        {
            var progress = new UploadProgress { FileName = file.Name };
            _uploadProgress.Add(progress);
            try
            {
                var doc = new Document
                {
                    Id = Guid.NewGuid(), FileName = file.Name, OriginalFileName = file.Name,
                    FileExtension = Path.GetExtension(file.Name).ToLowerInvariant(), ContentType = file.ContentType,
                    FileSize = file.Size, Status = DocumentStatus.Pending, Source = DocumentProcessor.Web.Models.DocumentSource.LocalUpload,
                    UploadedAt = DateTime.UtcNow, UploadedBy = "System", CreatedAt = DateTime.UtcNow, UpdatedAt = DateTime.UtcNow
                };

                using var stream = file.OpenReadStream(MaxFileSize);
                doc.StoragePath = await DocumentSource.SaveDocumentAsync(stream, file.Name);
                progress.Progress = 50;
                StateHasChanged();

                Document savedDoc;
                using (var scope = ServiceScopeFactory.CreateScope())
                {
                    savedDoc = await scope.ServiceProvider.GetRequiredService<DocumentRepository>().AddAsync(doc);
                }
                progress.Progress = 75;
                StateHasChanged();

                try
                {
                    await DocumentProcessingService.QueueDocumentForProcessingAsync(savedDoc.Id);
                    AddMessage($"'{file.Name}' uploaded and queued", "success");
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Queue failed");
                    AddMessage($"'{file.Name}' uploaded but queue failed", "warning");
                }
                progress.Progress = 100;
                progress.IsComplete = true;
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Upload failed");
                progress.Error = "Upload failed";
                AddMessage($"Failed '{file.Name}'", "danger");
            }
            StateHasChanged();
        }

        _isUploading = false;
        _selectedFiles.Clear();
        await LoadRecentDocuments();
    }

    private string GetFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double size = bytes;
        int order = 0;
        while (size >= 1024 && order < 3) { order++; size /= 1024; }
        return $"{size:0.##} {sizes[order]}";
    }

    private string GetStatusColor(DocumentStatus status) => status switch
    {
        DocumentStatus.Pending => "warning", DocumentStatus.Processing => "info",
        DocumentStatus.Processed => "success", DocumentStatus.Failed => "danger", _ => "secondary"
    };

    private void AddMessage(string text, string type) => _messages.Add(new Message { Text = text, Type = type });

    record UploadProgress { public string FileName { get; set; } = ""; public int Progress { get; set; } public bool IsComplete { get; set; } public string? Error { get; set; } }
    record Message { public string Text { get; set; } = ""; public string Type { get; set; } = "info"; }
}